<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>–ì—Ä–∞ –ë–£–ù–ö–ï–†</title>
    <style>
        /* --- 1. –û–°–ù–û–í–ù–ò–ô –î–ò–ó–ê–ô–ù --- */
        body { 
            font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; 
            margin: 0; padding: 20px; text-align: center; 
            overflow-x: hidden; /* –©–æ–± –Ω–µ –±—É–ª–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª—É */
        }
        
        .container { 
            max-width: 500px; margin: 0 auto; padding-bottom: 80px; 
            transition: filter 0.3s; /* –î–ª—è –µ—Ñ–µ–∫—Ç—É —Ä–æ–∑–º–∏—Ç—Ç—è */
        }
        
        /* –ï—Ñ–µ–∫—Ç —Ä–æ–∑–º–∏—Ç—Ç—è —Ñ–æ–Ω—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ */
        body.modal-open .container { filter: blur(5px); pointer-events: none; }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        
        h1 { color: #ffcc00; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 30px; }

        /* --- 2. –ï–õ–ï–ú–ï–ù–¢–ò –£–ü–†–ê–í–õ–Ü–ù–ù–Ø --- */
        input { 
            width: 80%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; 
            background: #333; color: #fff; font-size: 1.1rem; text-align: center; outline: none;
        }
        input:focus { box-shadow: 0 0 0 2px #ffcc00; }

        .main-btn {
            background: #ffcc00; color: #000; border: none; padding: 15px 30px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; width: 90%; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.3); transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.95); }

        /* --- 3. –°–ü–ò–°–û–ö –ì–†–ê–í–¶–Ü–í (–õ–û–ë–Ü) --- */
        #player-list { list-style: none; padding: 0; text-align: left; }
        #player-list li { 
            background: #2b2b2b; margin: 5px 0; padding: 15px; border-radius: 8px; 
            border-left: 4px solid #ffcc00; font-size: 1.1rem;
        }

        /* --- 4. –Ü–ù–§–û-–ë–õ–û–ö–ò (–ö–ê–¢–ê–°–¢–†–û–§–ê/–ë–£–ù–ö–ï–†) --- */
        .info-box {
            padding: 15px; border-radius: 10px; margin-bottom: 15px; 
            text-align: left; position: relative; border: 2px solid rgba(255,255,255,0.1);
        }
        .disaster-box { background: linear-gradient(135deg, #b71c1c, #880e4f); box-shadow: 0 5px 15px rgba(183, 28, 28, 0.4); }
        .bunker-box { background: linear-gradient(135deg, #0d47a1, #1565c0); box-shadow: 0 5px 15px rgba(13, 71, 161, 0.4); }
        
        .box-icon { 
            position: absolute; top: -10px; right: 10px; 
            background: #222; padding: 4px 10px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: bold; border: 1px solid #555; box-shadow: 0 2px 5px #000;
        }
        
        .info-box h2 { margin: 10px 0 5px 0; font-size: 1.4rem; color: white; text-shadow: 1px 1px 2px black; }
        .info-box p { margin: 5px 0; font-size: 0.95rem; line-height: 1.4; color: #eee; }
        .sub-info { font-size: 0.9rem; color: #ddd; margin-top: 8px; font-style: italic; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; }
        
        .places-counter { 
            margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); 
            text-align: center; font-weight: bold; font-size: 1.1rem;
        }

        /* --- 5. –ö–ê–†–¢–ö–ê –ì–†–ê–í–¶–Ø --- */
        .card { background: #2b2b2b; padding: 20px; border-radius: 15px; text-align: left; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .section:last-child { border-bottom: none; }
        
        .label { color: #888; font-size: 0.8rem; text-transform: uppercase; display: block; margin-bottom: 4px; letter-spacing: 1px; }
        .val { font-size: 1.1rem; font-weight: 500; color: #fff; }
        .abil { color: #f0a500; font-size: 0.95rem; font-style: italic; margin-top: 3px; }

        /* --- 6. –ö–ù–û–ü–ö–ò –î–Ü–ô (USE) --- */
        .use-btn {
            display: inline-block; margin-top: 8px; padding: 8px 16px;
            background: #444; color: #fff; border: 1px solid #666;
            border-radius: 6px; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; font-weight: bold;
            transition: all 0.2s;
        }
        .use-btn:hover { background: #666; border-color: #999; }
        .use-btn:active { transform: scale(0.95); }
        .use-btn:disabled { background: #222; color: #555; border-color: #333; cursor: not-allowed; }

        /* –°—Ç–∞–Ω "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ" */
        .used-state { opacity: 0.5; filter: grayscale(1); pointer-events: none; }

        /* --- 7. –°–ü–ï–¶–ö–ê–†–¢–ö–ò --- */
        .action-card {
            background: #333; border: 1px dashed #666; 
            padding: 15px; margin-top: 15px; border-radius: 10px; position: relative;
        }
        .action-card h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: #ff9966; }
        .action-card p { margin: 0 0 10px 0; font-size: 0.95rem; color: #ccc; }

        /* --- 8. –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û (–í–ò–ë–Ü–† –¶–Ü–õ–Ü) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; 
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: popIn 0.3s; }
        
        .modal-box {
            background: #2b2b2b; width: 90%; max-width: 350px; padding: 25px;
            border-radius: 15px; border: 2px solid #ffcc00; text-align: center;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);
        }
        .modal-box h3 { margin-top: 0; color: #ffcc00; text-transform: uppercase; }
        
        .target-list { 
            list-style: none; padding: 0; margin: 20px 0; 
            max-height: 300px; overflow-y: auto; 
        }
        .target-list li {
            background: #444; margin: 8px 0; padding: 12px; border-radius: 8px;
            cursor: pointer; transition: background 0.2s; color: white; border: 1px solid #555;
            font-weight: bold;
        }
        .target-list li:hover { background: #ffcc00; color: #000; border-color: #ffcc00; }
        
        .cancel-btn { 
            background: transparent; border: 1px solid #888; color: #888; 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; 
        }
        .cancel-btn:hover { border-color: #eee; color: #eee; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚ò¢Ô∏è B.U.N.K.E.R ‚ò¢Ô∏è</h1>

        <div id="screen-login" class="screen active">
            <p style="color:#888; margin-bottom: 20px;">–í–≤–µ–¥–∏ —Å–≤–æ—î —ñ–º'—è —Ç–∞ –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏</p>
            <input type="text" id="username" placeholder="–¢–≤–æ—î —ñ–º'—è (–Ω–∞–ø—Ä. –°—Ç–∞–ª–∫–µ—Ä)" autocomplete="off">
            <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (–Ω–∞–ø—Ä. 777)" autocomplete="off">
            <button class="main-btn" onclick="joinGame()">–£–í–Ü–ô–¢–ò</button>
        </div>

        <div id="screen-lobby" class="screen">
            <h2>–õ–æ–±—ñ</h2>
            <div style="background: #333; padding: 10px; border-radius: 10px; display: inline-block; margin-bottom: 10px;">
                –ö—ñ–º–Ω–∞—Ç–∞: <strong id="display-room" style="color:#ffcc00; font-size: 1.2rem;">---</strong>
            </div>
            
            <p style="text-align: left; color: #888; margin-left: 5px;">–°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤:</p>
            <ul id="player-list"></ul>
            
            <button id="btn-start" class="main-btn" onclick="startGame()" style="display:none; background: #d32f2f; color: white;">
                –ü–û–ß–ê–¢–ò –ì–†–£ üöÄ
            </button>
            <p id="wait-msg" style="color: #666; margin-top: 20px; font-style: italic;">–ß–µ–∫–∞—î–º–æ –Ω–∞ –∞–¥–º—ñ–Ω–∞...</p>
        </div>

        <div id="screen-game" class="screen">
            
            <div class="info-box disaster-box">
                <div class="box-icon">üî• –ö–ê–¢–ê–°–¢–†–û–§–ê</div>
                <h2 id="dst-name">–ù–∞–∑–≤–∞</h2>
                <p id="dst-desc"></p>
                <div class="sub-info">‚è≥ <span id="dst-time"></span></div>
                <div class="sub-info">‚ÑπÔ∏è <span id="dst-res"></span></div>
            </div>

            <div class="info-box bunker-box">
                <div class="box-icon">üõ°Ô∏è –ë–£–ù–ö–ï–†</div>
                <h2 id="bnk-name">–ù–∞–∑–≤–∞</h2>
                <p id="bnk-desc"></p>
                <div class="sub-info">üì¶ <span id="bnk-sup"></span></div>
                <div class="places-counter">
                    –ú–Ü–°–¶–¨: <span id="bnk-places" style="font-size:1.4em; color: #ffeb3b;">0</span> 
                    <span style="font-size: 0.8em; font-weight: normal;">(–ì—Ä–∞–≤—Ü—ñ–≤: <span id="bnk-total">0</span>)</span>
                </div>
            </div>

            <div class="card">
                
                <div class="section">
                    <span class="label">üë§ –ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è</span>
                    <div class="val" id="bio-identity"></div>
                </div>

                <div class="section">
                    <span class="label">üìè –¢—ñ–ª–æ–±—É–¥–æ–≤–∞</span>
                    <div class="val" id="bio-body"></div>
                </div>

                <div class="section">
                    <span class="label">üõ† –ü—Ä–æ—Ñ–µ—Å—ñ—è</span>
                    <div class="val" id="prof"></div>
                    <div class="abil" id="prof-ab"></div>
                    <button class="use-btn" id="btn-prof-use">–í–ò–ö–û–†–ò–°–¢–ê–¢–ò</button>
                </div>

                <div class="section">
                    <span class="label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤'—è</span>
                    <div class="val" id="health"></div>
                </div>

                <div class="section">
                    <span class="label">üò± –§–æ–±—ñ—è</span>
                    <div class="val" id="fear" style="color: #ff8a80;"></div>
                </div>

                <div class="section">
                    <span class="label">üé≤ –•–æ–±—ñ</span>
                    <div class="val" id="hobby"></div>
                    <div class="abil" id="hobby-ab"></div>
                </div>

                <div class="section">
                    <span class="label">üéí –†—é–∫–∑–∞–∫ (–î—Ä—ñ–±–Ω–µ)</span>
                    <div class="val" id="bag-small"></div>
                </div>

                <div class="section">
                    <span class="label">üß≥ –í–∞–ª—ñ–∑–∞ (–í–µ–ª–∏–∫–µ)</span>
                    <div class="val" id="bag-big"></div>
                </div>

                <div class="section">
                    <span class="label">üìÑ –§–∞–∫—Ç</span>
                    <div class="val" id="fact" style="font-style: italic; color: #aaa;"></div>
                </div>

                <div class="section" style="border-top: 2px solid #555; margin-top: 20px; padding-top: 15px; border-bottom: none;">
                    <span class="label" style="text-align:center; margin-bottom:10px; color:#ffcc00">üÉè –í–ê–®–Ü –°–ü–ï–¶–ö–ê–†–¢–ö–ò</span>
                    <div id="action-cards-container"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal-select" class="modal-overlay">
        <div class="modal-box">
            <h3>–û–ë–ï–†–ò –¶–Ü–õ–¨ üéØ</h3>
            <ul id="target-list" class="target-list"></ul>
            <button class="cancel-btn" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let currentRoom = "";
        let allPlayers = [];
        let pendingAction = null; // { type: 'card'|'prof', id: '...' }

        // --- –í–•–Ü–î ---
        function joinGame() {
            const name = document.getElementById('username').value;
            const room = document.getElementById('roomCode').value;
            if(!name || !room) return alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!");
            currentRoom = room;
            socket.emit('join_room', { name, roomCode: room });
            showScreen('screen-lobby');
            document.getElementById('display-room').innerText = room;
        }

        // --- –û–ù–û–í–õ–ï–ù–ù–Ø –°–ü–ò–°–ö–£ –ì–†–ê–í–¶–Ü–í ---
        socket.on('update_players', (players) => {
            allPlayers = players; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–ª—è –º–æ–¥–∞–ª–∫–∏
            const list = document.getElementById('player-list');
            list.innerHTML = "";
            const me = players.find(p => p.id === socket.id);
            players.forEach(p => {
                const li = document.createElement('li');
                li.innerText = p.name + (p.isHost ? " üëë" : "");
                list.appendChild(li);
            });
            if (me && me.isHost) {
                document.getElementById('btn-start').style.display = 'block';
                document.getElementById('wait-msg').style.display = 'none';
            }
        });

        // --- –°–¢–ê–†–¢ –ì–†–ò ---
        function startGame() { socket.emit('start_game', currentRoom); }

        // --- –†–ï–ù–î–ï–† –ì–†–ò ---
        socket.on('game_started', (data) => {
            showScreen('screen-game');
            const g = data.game;
            const p = data.me;
            const usedCards = data.usedCards || [];

            // –ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞ / –ë—É–Ω–∫–µ—Ä
            document.getElementById('dst-name').innerText = g.disaster.name;
            document.getElementById('dst-desc').innerText = g.disaster.description;
            document.getElementById('dst-time').innerText = g.disaster.time;
            document.getElementById('dst-res').innerText = g.disaster.residue;

            document.getElementById('bnk-name').innerText = g.bunker.name;
            document.getElementById('bnk-desc').innerText = g.bunker.description;
            document.getElementById('bnk-sup').innerText = g.bunker.supplies;
            document.getElementById('bnk-places').innerText = g.places;
            document.getElementById('bnk-total').innerText = g.total_players;

            // –ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è
            if(p.bio) {
                document.getElementById('bio-identity').innerText = `${p.bio.sex}, ${p.bio.age}—Ä (${p.bio.gender})`;
                document.getElementById('bio-body').innerText = `${p.bio.height} —Å–º, ${p.bio.weight} –∫–≥`;
            }

            // –ü—Ä–æ—Ñ–µ—Å—ñ—è
            if(p.profession) {
                document.getElementById('prof').innerText = p.profession.name;
                document.getElementById('prof-ab').innerText = p.profession.ability;
                
                const btn = document.getElementById('btn-prof-use');
                if(data.professionUsed) {
                    btn.innerText = "–í–ò–ö–û–†–ò–°–¢–ê–ù–û";
                    btn.disabled = true;
                    btn.parentElement.classList.add('used-state');
                } else {
                    btn.innerText = "–í–ò–ö–û–†–ò–°–¢–ê–¢–ò";
                    btn.disabled = false;
                    btn.parentElement.classList.remove('used-state');
                    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó
                    btn.onclick = () => preCheckAction('prof', null, p.profession.id);
                }
            }

            // –ó–¥–æ—Ä–æ–≤'—è / –§–æ–±—ñ—ó / –•–æ–±—ñ
            if(p.health) document.getElementById('health').innerText = `${p.health.name} ${p.health.stage || ''}`;
            if(p.fear) document.getElementById('fear').innerText = p.fear;
            if(p.hobby) {
                document.getElementById('hobby').innerText = p.hobby.name;
                document.getElementById('hobby-ab').innerText = p.hobby.ability;
            }
            if(p.baggage) {
                document.getElementById('bag-small').innerText = p.baggage.small;
                document.getElementById('bag-big').innerText = p.baggage.big;
            }
            if(p.fact) document.getElementById('fact').innerText = p.fact;

            // –ö–∞—Ä—Ç–∫–∏
            const cardsCont = document.getElementById('action-cards-container');
            cardsCont.innerHTML = "";
            if (p.cards && p.cards.length > 0) {
                p.cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'action-card';
                    const isUsed = usedCards.includes(card.id);
                    
                    div.innerHTML = `
                        <h3>${card.name}</h3>
                        <p>${card.description}</p>
                        <button class="use-btn" ${isUsed ? 'disabled' : ''}>
                            ${isUsed ? "–í–ñ–ï –í–ò–ö–û–†–ò–°–¢–ê–ù–û" : "–í–ò–ö–û–†–ò–°–¢–ê–¢–ò"}
                        </button>
                    `;
                    if(isUsed) div.classList.add('used-state');
                    else {
                        div.querySelector('button').onclick = () => preCheckAction('card', card, card.id);
                    }
                    cardsCont.appendChild(div);
                });
            } else {
                cardsCont.innerHTML = "<p style='color:#666'>–ù–µ–º–∞—î –∫–∞—Ä—Ç–æ–∫</p>";
            }
        });

        // --- –õ–û–ì–Ü–ö–ê –î–Ü–ô –¢–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê ---

        function preCheckAction(type, obj, id) {
            // –ó–∞–≤–∂–¥–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –¥–ª—è –≤–∏–±–æ—Ä—É –≥—Ä–∞–≤—Ü—è
            // –¶–µ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥. –Ø–∫—â–æ –∫–∞—Ä—Ç–∫–∞ "–Ω–∞ –≤—Å—ñ—Ö", ID —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º.
            pendingAction = { type, id };
            openModal();
        }

        function openModal() {
            const list = document.getElementById('target-list');
            list.innerHTML = "";
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤
            allPlayers.forEach(player => {
                const li = document.createElement('li');
                li.innerText = player.name + (player.id === socket.id ? " (–Ø)" : "");
                li.onclick = () => confirmSelection(player.id);
                list.appendChild(li);
            });

            document.getElementById('modal-select').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('modal-select').classList.remove('active');
            document.body.classList.remove('modal-open');
            pendingAction = null;
        }

        function confirmSelection(targetId) {
            if(!pendingAction) return;
            
            if(pendingAction.type === 'card') {
                socket.emit('use_card', { roomCode: currentRoom, cardId: pendingAction.id, targetId });
            } else if (pendingAction.type === 'prof') {
                socket.emit('use_profession', { roomCode: currentRoom, targetId });
            }
            closeModal();
        }

        socket.on('notification', msg => alert("üîî " + msg));

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>